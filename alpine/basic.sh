#!/bin/sh

set -e

DISK="/dev/sda"
PART="${DISK}1"
MNT="/mnt"

echo "üö® –í–ù–ò–ú–ê–ù–ò–ï: –í–°–ï –î–ê–ù–ù–´–ï –ù–ê ${DISK} –ë–£–î–£–¢ –£–î–ê–õ–ï–ù–´!"
sleep 3

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –¥–∏—Å–∫–∞
if [ ! -b "$DISK" ]; then
  echo "‚ùå –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ $DISK –Ω–µ –Ω–∞–π–¥–µ–Ω–æ"
  exit 1
fi

echo "üìõ –†–∞–∑–º–µ—Ç–∫–∞ –¥–∏—Å–∫–∞ $DISK..."
parted --script "$DISK" mklabel gpt
parted --script "$DISK" mkpart primary ext4 1MiB 100%

# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —Ä–∞–∑–¥–µ–ª–æ–≤
sleep 1
echo "üîÅ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —Ä–∞–∑–¥–µ–ª–æ–≤..."
partprobe "$DISK" || true
sleep 1

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—è–≤–ª–µ–Ω–∏—è —Ä–∞–∑–¥–µ–ª–∞
if [ ! -b "$PART" ]; then
  echo "‚ùå –†–∞–∑–¥–µ–ª $PART –Ω–µ –Ω–∞–π–¥–µ–Ω. –ß—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫."
  exit 1
fi

echo "üßº –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ $PART –≤ ext4..."
mkfs.ext4 -F "$PART"

# –°–æ–∑–¥–∞–Ω–∏–µ —Ç–æ—á–∫–∏ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
mkdir -p "$MNT"

echo "üìÇ –ú–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ $PART –≤ $MNT..."
mount "$PART" "$MNT"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å–ø–µ—à–Ω–æ–≥–æ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
if mountpoint -q "$MNT"; then
  echo "‚úÖ –£—Å–ø–µ—à–Ω–æ —Å–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ –≤ $MNT"
else
  echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–º–æ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å $PART –≤ $MNT"
  exit 1
fi
